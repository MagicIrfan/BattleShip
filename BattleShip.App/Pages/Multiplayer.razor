@page "/multiplayer"
@using System.Net.Http.Headers
@using Microsoft.AspNetCore.SignalR.Client
@inject HttpClient HttpClient
@inject ITokenService TokenService

<h3>Multiplayer BattleShip</h3>

<div class="game-setup">
    <label>Enter Game ID (or create new one):</label>
    <input @bind="_gameIdInput" placeholder="Enter or generate a Game ID" />
    <button @onclick="JoinGame">Join Game</button>
</div>

@if (!string.IsNullOrEmpty(_message))
{
    <p class="error-message">@_message</p>
}

@if (_gameId != Guid.Empty)
{
    <p>Connected to Game ID: <strong>@_gameId</strong></p>
    <button @onclick="LeaveGame" class="leave-button">Leave Game</button>
}

@if (_playerProfiles.Count > 0)
{
    <div class="players-section">
        <h4>Players in Game:</h4>
        <div class="player-list">
            @foreach (var player in _playerProfiles)
            {
                <div class="player-card">
                    <div class="player-icon">
                        @if (_readyPlayers.Contains(player.Username))
                        {
                            <span class="checkmark">✔️</span>
                        }

                        @if (!string.IsNullOrEmpty(player.Picture))
                        {
                            <img src="@player.Picture" alt="Profile Picture" class="profile-picture" />
                        }
                        else
                        {
                            <span>👤</span> 
                        }
                    </div>

                    <div class="player-id">
                        <span>@player.Username</span>
                    </div>
                </div>
            }
        </div>
    </div>

    <button @onclick="SetReady" disabled="@(!IsReadyEnabled)" class="ready-button">
        Prêt
    </button>

}

@code {
    private string _gameIdInput = string.Empty;
    private Guid _gameId;
    private HubConnection HubConnection;
    private HashSet<string> _readyPlayers = [];
    private bool IsReadyEnabled => _playerProfiles.Count == 2;
    private string _message = string.Empty;
    private List<PlayerInfo> _playerProfiles = [];
    private string? _profilePicture;
    private string? _playerName;
    private string? _playerId;

    protected override async Task OnInitializedAsync()
    {
        var token = await TokenService.GetAccessTokenAsync();
        
        await LoadPlayerProfile();

        HubConnection = new HubConnectionBuilder()
            .WithUrl("https://localhost:5134/gamehub", options =>
            {
                options.AccessTokenProvider = () => Task.FromResult(token)!;
            })
            .Build();

        HubConnection.On<List<PlayerInfo>>("UpdatePlayerList", (playerList) =>
        {
            _playerProfiles.Clear();
            _playerProfiles.AddRange(playerList);
            StateHasChanged(); 
        });

        HubConnection.On<HashSet<string>>("UpdateReadyStatus", (readyPlayersList) =>
        {
            _readyPlayers = [..readyPlayersList];
            StateHasChanged();
        });

        HubConnection.On("AlreadyJoin", () =>
        {
            _message = "You have already joined this game.";
            StateHasChanged();
        });

        HubConnection.On("GameIsFull", () =>
        {
            _message = "The game is full.";
            StateHasChanged();
        });

        await HubConnection.StartAsync();
    }
    
    private async Task JoinGame()
    {
        _message = string.Empty;
        if (Guid.TryParse(_gameIdInput, out var parsedGameId))
        {
            _gameId = parsedGameId;
        }
        else
        {
            _gameId = Guid.NewGuid();
            _gameIdInput = _gameId.ToString();
        }

        await HubConnection.SendAsync("JoinLobby", _gameId, _playerName, _profilePicture);
        _playerProfiles.Clear();
    }

    private async Task LeaveGame()
    {
        await HubConnection.SendAsync("LeaveGame", _gameId);
        _gameId = Guid.Empty; 
        _playerProfiles.Clear();
        _message = string.Empty;
        StateHasChanged();
    }

    private async Task SetReady()
    {
        await HubConnection.SendAsync("SetReady", _gameId);
    }

    private async Task LoadPlayerProfile()
    {
        try
        {
            var token = await TokenService.GetAccessTokenAsync();
            HttpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
            var response = await HttpClient.GetAsync("https://localhost:5134/api/auth/profile");

            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadFromJsonAsync<Dictionary<string, string>>();
            
                if (content!.TryGetValue("userName", out var username))
                {
                    _playerName = username; 
                }

                if (content.TryGetValue("picture", out var picture))
                {
                    _profilePicture = picture;
                }
            }
            else
            {
                throw new Exception("Failed to load player profile");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"An error occurred: {ex.Message}");
        }
        finally
        {
            StateHasChanged();
        }
    }

}


<style>
    .error-message {
        color: red;
        font-weight: bold;
        margin-top: 0.5em;
    }
    
    .game-setup {
        margin-bottom: 1em;
    }

    .players-section {
        margin-top: 1em;
    }

    .player-list {
        display: flex;
        flex-wrap: wrap;
    }

    .player-card {
        border: 1px solid #ccc;
        padding: 1em;
        margin: 0.5em;
        text-align: center;
        width: 120px;
        background-color: #f9f9f9;
        border-radius: 8px;
        position: relative;
    }

    .player-icon {
        font-size: 2em;
    }

    .player-id {
        margin-top: 0.5em;
        font-weight: bold;
    }

    .leave-button {
        background-color: #ff6b6b;
        border: none;
        color: white;
        padding: 0.5em 1em;
        font-size: 1em;
        border-radius: 4px;
        cursor: pointer;
    }

    .ready-button {
        display: block;
        margin-top: 1em;
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 0.5em 2em;
        font-size: 1em;
        border-radius: 4px;
        cursor: pointer;
    }

    .ready-button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    .profile-picture {
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }

    .checkmark {
        position: absolute;
        top: -10px;
        right: -10px;
        font-size: 1.5em;
        color: green;
    }
</style>
